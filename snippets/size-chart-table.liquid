{% doc %}
  Renders a size chart table with configurable column order and footer

  @param {object} size_chart - The size_chart metaobject (required)
  @param {string} [column_order] - Comma-separated list of fields

  If not provided, will auto-detect based on product type/tags

  @param {string} [footer_prefix] - Text before the first link (default: 'If you have any questions about sizing, please')
  @param {string} [contact_link_text] - Text for the contact link (default: 'contact us')
  @param {string} [contact_link_url] - URL for the contact link (default: '/pages/contact-us')
  @param {string} [footer_middle] - Text between links (default: 'before purchasing. Model details')
  @param {string} [model_link_text] - Text for the model details link (default: 'here')
  @param {string} [model_link_url] - URL for the model details link (optional, if blank, text won't be a link)

  @example
  {% render 'size-chart-table',
      size_chart: size_chart,
      column_order: 'chest,shoulder,back,sleeve',
      footer_prefix: 'Questions about sizing?',
      contact_link_text: 'Get in touch',
      contact_link_url: '/pages/contact',
      footer_middle: 'before ordering. See model info',
      model_link_text: 'here',
      model_link_url: '/pages/model-details'
  %}
{% enddoc %}

{% liquid
  # Parameter defaults
  assign footer_prefix = footer_prefix | default: 'If you have any questions about sizing, please'
  assign contact_link_text = contact_link_text | default: 'contact us'
  if contact_link_url == blank
    assign contact_link_url = '/pages/contact-us'
  endif
  assign footer_middle = footer_middle | default: 'before purchasing. Model details'
  assign model_link_text = model_link_text | default: 'here'
  if model_link_url == blank
    assign model_link_url = ''
  endif

  # Column display names mapping (metafield_name:Display Name)
  assign column_labels = 'chest:Chest,shoulder:Shoulder,back:Back,sleeve:Arm,waist:Waist,rise:Rise,inside_leg:Inside Leg,leg_opening:Leg Opening' | split: ','

  # Define default column orders for different garment types
  assign jacket_order = 'chest,shoulder,back,sleeve'
  assign pants_order = 'waist,rise,inside_leg,leg_opening'
  assign default_order = 'chest,shoulder,back,sleeve,waist,rise,inside_leg,leg_opening'

  # Determine column order
  if column_order != blank
    # Use provided order
    assign columns = column_order | split: ','
  elsif size_chart.product_type != blank
    # Use product_type from the metaobject itself
    assign product_type_lower = size_chart.product_type | downcase
    if product_type_lower contains 'jacket'
      assign columns = jacket_order | split: ','
    elsif product_type_lower contains 'pant'
      assign columns = pants_order | split: ','
    else
      assign columns = default_order | split: ','
    endif
  elsif product.tags contains 'jacket' or product.tags contains 'Jacket' or product.type contains 'Jacket' or product.title contains 'Jacket'
    # Use jacket order based on product info
    assign columns = jacket_order | split: ','
  elsif product.tags contains 'pants' or product.tags contains 'Pants' or product.type contains 'Pants' or product.title contains 'Pant'
    # Use pants order based on product info
    assign columns = pants_order | split: ','
  else
    # Use default order but only show fields that have data
    assign columns = default_order | split: ','
  endif
%}

<div class="flex flex-col">
  <table class="size-chart">
    <thead>
      <tr>
        <th class="py-2 font-normal w-16 text-center align-bottom">Size</th>
        {% for column in columns %}
          {% assign field_name = column | strip %}
          {% assign field_value = size_chart[field_name] %}

          {% if field_value != blank %}
            <th class="py-2 font-normal w-16 text-center align-bottom">
              {%- comment -%} Find the display label for this field {%- endcomment -%}
              {% assign display_label = '' %}
              {% for label_pair in column_labels %}
                {% assign pair_parts = label_pair | split: ':' %}
                {% if pair_parts[0] == field_name %}
                  {% assign display_label = pair_parts[1] %}
                  {% break %}
                {% endif %}
              {% endfor %}

              {%- comment -%} Fallback to capitalized field name if no label found {%- endcomment -%}
              {% if display_label == '' %}
                {% assign display_label = field_name | capitalize %}
              {% endif %}

              {{ display_label }}
            </th>
          {% endif %}
        {% endfor %}
      </tr>
    </thead>
    <tbody class="font-sans">
      {% for size in size_chart.sizes.value %}
        <tr>
          <td class="py-3 w-16 text-center">{{ size }}</td>
          {% for column in columns %}
            {% assign field_name = column | strip %}
            {% assign field_value = size_chart[field_name] %}

            {% if field_value != blank %}
              <td class="py-3 w-16 text-center">
                {{- field_value.value[forloop.index0] -}}
                {{- size_chart.unit -}}
              </td>
            {% endif %}
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <p class="text-center text-sm md:text-base font-sans font-normal text-subtitle leading-[1.4] p-4 md:p-8">
    {%- if footer_prefix != blank -%}
      {{ footer_prefix }}
    {%- endif %}
    {%- if contact_link_text != blank and contact_link_url != blank %}
      <a href="{{ contact_link_url }}" class="text-subtitle underline hover:no-underline transition-all">
        {{- contact_link_text -}}
      </a>
    {%- endif %}
    {%- if footer_middle != blank %}
      {{ footer_middle }}
    {%- endif %}
    {%- if model_link_text != blank %}
      {%- if model_link_url != blank %}
        <a href="{{ model_link_url }}" class="text-subtitle underline hover:no-underline transition-all">
          {{- model_link_text -}}</a
        >.
      {%- else %}
        {{ model_link_text }}.
      {%- endif %}
    {%- endif -%}
  </p>
</div>
