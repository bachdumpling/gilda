{%- comment -%}
  Product Structured Data (JSON-LD)
  Generates Schema.org structured data for products to fix Google Search Console issues.
  Includes:
  - MerchantReturnPolicy (linked to orders-shipping page)
  - ShippingDetails (Free shipping for US)
  - PriceValidUntil (1 year from now)
  - Detailed product info
{%- endcomment -%}

{%- liquid
  assign current_variant = product.selected_or_first_available_variant
  assign description = product.description | strip_html | default: shop.name | escape
  assign featured_image = product.featured_media | image_url: width: 1200 | prepend: 'https:'
  assign price_valid_until = 'now' | date: '%s' | plus: 31536000 | date: '%Y-%m-%d'
  assign return_policy_url = shop.url | append: '/pages/orders-shipping'
-%}

<script type="application/ld+json">
  {
    "@context": "https://schema.org/",
    "@type": "Product",
    "name": "{{ product.title | escape }}",
    "image": "{{ featured_image }}",
    "description": "{{ description }}",
    "brand": {
      "@type": "Brand",
      "name": "{{ product.vendor | default: shop.name | escape }}"
    },
    "sku": "{{ current_variant.sku | default: current_variant.id }}",
    "offers": [
      {%- for variant in product.variants -%}
      {
        "@type": "Offer",
        "priceCurrency": "{{ cart.currency.iso_code }}",
        "price": "{{ variant.price | divided_by: 100.00 }}",
        "itemCondition": "https://schema.org/NewCondition",
        "availability": "https://schema.org/{%- if variant.available -%}InStock{%- else -%}OutOfStock{%- endif -%}",
        "url": "{{ shop.url }}{{ variant.url }}",
        "priceValidUntil": "{{ price_valid_until }}",
        "hasMerchantReturnPolicy": {
          "@type": "MerchantReturnPolicy",
          "applicableCountry": "US",
          "returnPolicyCategory": "https://schema.org/MerchantReturnNotPermitted",
          "merchantReturnLink": "{{ return_policy_url }}"
        },
        "shippingDetails": {
          "@type": "OfferShippingDetails",
          "shippingRate": {
            "@type": "MonetaryAmount",
            "value": 0,
            "currency": "USD"
          },
          "shippingDestination": {
            "@type": "DefinedRegion",
            "addressCountry": "US"
          },
          "deliveryTime": {
            "@type": "ShippingDeliveryTime",
            "handlingTime": {
              "@type": "QuantitativeValue",
              "minValue": 1,
              "maxValue": 2,
              "unitCode": "DAY"
            },
            "transitTime": {
              "@type": "QuantitativeValue",
              "minValue": 3,
              "maxValue": 7,
              "unitCode": "DAY"
            }
          }
        }
      }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    ]
    {%- if product.metafields.reviews.rating.value != blank -%}
    ,"aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "{{ product.metafields.reviews.rating.value }}",
      "reviewCount": "{{ product.metafields.reviews.rating_count.value }}"
    }
    {%- endif -%}
  }
</script>
