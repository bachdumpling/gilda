{% doc %}
  Product Code Display

  Renders product code with smooth fade animation on hover to show full names.

  @param {product} product - Product object (required)
  @param {string} class - Additional CSS classes (default: '')
  @param {number} animation_duration - Animation duration in ms (default: 300)

  @example
  {% render 'product-code', 
       product: product, 
       class: 'text-sm hover:underline',
       animation_duration: 250 %}
{% enddoc %}

{% liquid
  # Parameter validation and defaults
  assign product = product | default: empty
  assign class = class | default: ''
  assign animation_duration = animation_duration | default: 300

  # Early return if required parameters missing
  unless product != empty
    echo '<!-- Error: product parameter required for product-code snippet -->'
    break
  endunless

  assign product_code = product.metafields.custom.product_code.value
  
  if product_code == blank
    assign product_code = product.title
  endif
  
  # Parse the product code format: "F25:Female-25, J1:Jacket-1, MS:Moleskin, BK:Black"
  assign code_parts = product_code | split: ', '
  assign short_codes = ''
  assign full_names = ''
  
  for part in code_parts
    assign code_mapping = part | split: ':'
    if code_mapping.size == 2
      assign short_code = code_mapping[0] | strip
      assign full_name = code_mapping[1] | strip
      
      if forloop.first == false
        assign short_codes = short_codes | append: '–'
        assign full_names = full_names | append: '–'
      endif
      
      assign short_codes = short_codes | append: '[' | append: short_code | append: ']'
      assign full_names = full_names | append: '[' | append: full_name | append: ']'
    endif
  endfor
%}

{% stylesheet %}
  .product-code {
    display: inline-block;
    transition: opacity 300ms ease-in-out;
    cursor: pointer;
  }
  
  .product-code.fading {
    opacity: 0;
  }

  .product-code.showing-full {
    text-decoration: underline;
  }
{% endstylesheet %}

{% if short_codes != blank %}
  <span 
    class="product-code {{ class }}" 
    data-short="{{ short_codes | escape }}"
    data-full="{{ full_names | escape }}"
    data-duration="{{ animation_duration }}"
  >
    {{ short_codes }}
  </span>

  {% unless request.design_mode %}
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const productCodes = document.querySelectorAll('.product-code');
        
        productCodes.forEach(function(element) {
          const shortCode = element.dataset.short;
          const fullCode = element.dataset.full;
          const duration = parseInt(element.dataset.duration) || 300;
          let isAnimating = false;
          let currentTimeout = null;
          
          function fadeToText(newText, isFull) {
            if (isAnimating) return;
            isAnimating = true;
            
            // Fade out
            element.classList.add('fading');
            
            setTimeout(function() {
              // Change text and fade in
              element.textContent = newText;
              element.classList.remove('fading');
              
              // Add or remove underline based on whether showing full code
              if (isFull) {
                element.classList.add('showing-full');
              } else {
                element.classList.remove('showing-full');
              }
              
              setTimeout(function() {
                isAnimating = false;
              }, duration);
            }, duration);
          }
          
          element.addEventListener('mouseenter', function() {
            if (currentTimeout) {
              clearTimeout(currentTimeout);
              currentTimeout = null;
            }
            fadeToText(fullCode, true);
          });
          
          element.addEventListener('mouseleave', function() {
            // Add small delay before reverting to prevent flickering
            currentTimeout = setTimeout(function() {
              fadeToText(shortCode, false);
              currentTimeout = null;
            }, 100);
          });
        });
      });
    </script>
  {% endunless %}
{% else %}
  <span class="{{ class }}">{{ product.title | escape }}</span>
{% endif %}
